---
title: "FIFA WC outcomes prediction"
author: "Thomas Fernandes"
date: "2023-04-12"
output:
  html_document:
    toc: yes
    toc_depth: '2'
    toc_float: true
    df_print: paged
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(readr)
library(plotly)
library(stargazer)
library(lmtest)
library(car)
library(webshot)
library(htmltools)
library(margins)
```

# 1. Introduction

## 1.1 Ce que dit l'article

Cet article examine la prévisibilité des résultats de la Coupe du monde de football en utilisant deux modèles empiriques. Depuis 1993, le système de classement mensuel de la FIFA (couramment appelé coefficient des pays) pour les équipes nationales de football seniors est devenu une source fiable pour juger du potentiel d'une équipe dans la compétition. Cependant, l'article montre que, malgré le nombre de surprises dans les résultats des matchs, les équipes les mieux classées ont généralement de meilleures performances. Les auteurs analysent les résultats des quatre Coupes du monde de la FIFA de 1994 à 2006 et utilisent les classements mensuels de la FIFA pour évaluer les performances des équipes. Deux modèles empiriques sont proposés : un modèle de régression linéaire et un modèle probit. Le premier modèle utilise la différence de buts comme variable expliquée pour voir si les équipes les mieux classées ont généralement des meilleures performances, tandis que le second évalue la probabilité de victoire pour chaque équipe en fonction de son classement FIFA et ainsi que d'autres variables de contrôles. Les auteurs trouvent des preuves empiriques que, malgré les surprises occasionnelles, les équipes les mieux classées ont généralement de meilleures performances.

## 1.2 Ce qu'on cherche à faire

L'objectif de cette étude est de répliquer les résultats de l'article en utilisant les mêmes données que les auteurs, ainsi que des données plus récentes. Cependant, certaines variables de contrôle utilisées dans l'article original ne sont pas disponibles pour la période de 2006 à 2022, telles que le nombre de corners et le nombre d'arrêts pour 2022.Ainsi, afin de pallier à cette lacune, nous avons sélectionné d'autres indicateurs pertinents pour les remplacer, tout en ajoutant de nouveaux, tels que le nombre de changements effectués par chaque équipe, le nombre total de tirs en plus du nombre de tirs cadrés, ainsi que le nombre d'arrêts. En utilisant ces variables alternatives, nous avons cherché à savoir si les conclusions de l'article original pouvaient être étendues à une période plus récente de la Coupe du monde de football. Nous avons également mis à l'épreuve la validité de la méthode de classement de la FIFA et de son utilisation en tant que proxy pour la performance des équipes.

# 2. Traitement des données

Les données liées aux coupes du monde n'étant officiellement plus disponible gratuitement sur le site de la FIFA, il faut se baser sur des données d'utilisateurs qui ont scrap le site de la FIFA dans l'objectif de répliquer ces bases de données.

Classement FIFA : https://www.kaggle.com/datasets/cashncarry/fifaworldranking — Alex Zabrodin
                  Ces données comprennent le classement fifa de 1992 (date de création) à nos jours

Coupe du monde 2022 : https://www.kaggle.com/datasets/die9origephit/fifa-world-cup-2022-complete-dataset — Diego Farchione
                      Database complète de toutes les statistiques de chaque match de la coupe du monde 2022
         
Matchs : https://www.kaggle.com/datasets/piterfm/fifa-football-world-cup — Petro Ivaniuk
      Base de données complète reprenant les contenant le score de tous les matchs de coupe du monde (1930-2022), les cartons (jaunes et rouges) et l'affluence
      
Matchs_stats: https://www.kaggle.com/datasets/kaito510/fifa-world-cup-match-stats — Kaito G.
      Contient les données de possession de balle, carton, tir cadrés de 2001 à 2021

## 2.1 Traitement des données de match

```{r}
WC_matches <- read.csv("WC Data/matches_1930_2022 (All).csv",
                    header = TRUE,
                    sep = ",",
                    stringsAsFactors = FALSE)

WC_matches <- WC_matches[c("home_team", "away_team", "home_score",
                           "away_score", "Attendance", "Round",
                           "Year", "home_red_card", "away_red_card",
                           "home_yellow_card_long", "away_yellow_card_long",
                           "home_substitute_in_long", "away_substitute_in_long")]

#Renomme les colonnes
colnames(WC_matches) <- c("Home", "Away", "Home.Goals", "Away.Goals",
                          "Attendance", "Round", "Year", "Home.Red.Card",
                          "Away.Red.Card", "Home.Yellow.Card",
                          "Away.Yellow.Card", "Home.Substitute.In",
                          "Away.Substitute.In")

#On extrait les variables de contrôles des string, et on créé les variables en différence
WC_matches$Goals_Diff             <- WC_matches$Home.Goals - WC_matches$Away.Goals
WC_matches$Home.Red.Card.Count    <- sapply(strsplit(WC_matches$Home.Red.Card, "\\|"), function(x) length(x))
WC_matches$Away.Red.Card.Count    <- sapply(strsplit(WC_matches$Away.Red.Card, "\\|"), function(x) length(x))
WC_matches$Red.Card.Diff          <- WC_matches$Home.Red.Card.Count - WC_matches$Away.Red.Card.Count
WC_matches$Home.Yellow.Card.Count <- sapply(strsplit(WC_matches$Home.Yellow.Card, ","), function(x) length(x))
WC_matches$Away.Yellow.Card.Count <- sapply(strsplit(WC_matches$Away.Yellow.Card, ","), function(x) length(x))
WC_matches$Yellow.Card.Diff       <- WC_matches$Home.Yellow.Card.Count - WC_matches$Away.Yellow.Card.Count
WC_matches$Home.Substitution.Count<- sapply(strsplit(WC_matches$Home.Substitute.In, ","), function(x) length(x))
WC_matches$Away.Substitution.Count<- sapply(strsplit(WC_matches$Away.Substitute.In, ","), function(x) length(x))
WC_matches$Substitution.Diff      <- WC_matches$Home.Substitution.Count - WC_matches$Away.Substitution.Count

WC_database <- WC_matches
WC_database <- subset(WC_database, Year >= 1994)

#Suppression des colonnes inutiles
WC_database <- WC_database[,-c(8,9,10,11,12, 13)]
```

## 2.2 Traitement des données de match supplémentaires

Pour les matchs les plus récents (à partir de la Coupe du Monde 2014), nous avons des données supplémentaires sur la possession de balle, le nombre de tir, de tir cadré, de fautes et d'arrêt : nos variables de contrôle.

```{r}
WC_matches_stats <- read.csv("WC Data/FIFAallMatchBoxData (Possesion 2001-2021).csv",
                    header = TRUE,
                    sep = ",",
                    stringsAsFactors = FALSE)

#On ne garde que les années de coupe du monde
WC_matches_stats <- subset(WC_matches_stats, year %in% c(2006, 2010,
                                                         2014, 2018, 2022))

#Uniformisation des noms de pays
WC_matches_stats <- WC_matches_stats %>% 
  mutate(hname = ifelse(hname == "South Korea", "Korea Republic", hname))
WC_matches_stats <- WC_matches_stats %>%
  mutate(aname = ifelse(aname == "South Korea", "Korea Republic", aname))
WC_matches_stats <- WC_matches_stats %>% 
  mutate(hname = ifelse(hname == "Ivory Coast", "Côte d'Ivoire", hname))
WC_matches_stats <- WC_matches_stats %>%
  mutate(aname = ifelse(aname == "Ivory Coast", "Côte d'Ivoire", aname))
WC_matches_stats <- WC_matches_stats %>% 
  mutate(hname = ifelse(hname == "Serbia & Montenegro", "Serbia and Montenegro", hname))
WC_matches_stats <- WC_matches_stats %>%
  mutate(aname = ifelse(aname == "Serbia & Montenegro", "Serbia and Montenegro", aname))

#Ajout des différences pour les nouvelles statistiques
WC_matches_stats <- WC_matches_stats %>% 
  mutate(Possession.Diff = hPossesion - aPossesion)
WC_matches_stats <- WC_matches_stats %>% 
  mutate(Shots.Diff = hshots - ashots)
WC_matches_stats <- WC_matches_stats %>% 
      mutate(Shots.On.Target.Diff = hshotsOnTarget - ashotsOnTarget)
WC_matches_stats <- WC_matches_stats %>% 
      mutate(Fouls.Diff = hfouls - afouls)
WC_matches_stats <- WC_matches_stats %>% 
      mutate(Saves.Diff = hsaves - asaves)

#Jointure de toutes les données dans le dataframe
WC_database_2 <- merge(WC_database, WC_matches_stats, 
                       by.x = c("Home", "Away", "Year"),
                       by.y = c("hname", "aname", "year"),
                       all.x = TRUE)
WC_database <- WC_database_2
rm(WC_database_2)


#Suppression des colonnes en double
WC_database <- subset(WC_database, select = -c(hgoals, agoals, hyellowCards,
                                               ayellowCards, hredCards, aredCards))
```

## 2.3 Traitement des données de la coupe du monde 2022

Les données de la dernière coupe du monde ne sont pas incluses dans les base de données précédemment utilisées. On va donc se servir d'une nouvelle base de données et la mettre au même format que WC_database pour pouvoir ensuite faire une jointure sur les deux.

```{r}
WC_matches_2022 <- read.csv("WC Data/Fifa_world_cup_matches_2022 (Cards).csv",
                    header = TRUE,
                    sep = ",",
                    stringsAsFactors = FALSE)

#On ajoute une colonne Year pour pouvoir merge avec les autres données
WC_matches_2022$Year <- 2022

#Colonnes de différence
WC_matches_2022$Goals_Diff       <- WC_matches_2022$number.of.goals.team1 - WC_matches_2022$number.of.goals.team2
WC_matches_2022$Yellow_Card_Diff <- WC_matches_2022$yellow.cards.team1 - WC_matches_2022$yellow.cards.team2
WC_matches_2022$Red_Card_Diff    <- WC_matches_2022$red.cards.team1 - WC_matches_2022$red.cards.team2

WC_matches_2022$possession.team1 <- gsub("%", "", WC_matches_2022$possession.team1)
WC_matches_2022$possession.team2 <- gsub("%", "", WC_matches_2022$possession.team2)
WC_matches_2022$possession.team1 <- as.numeric(WC_matches_2022$possession.team1)
WC_matches_2022$possession.team2 <- as.numeric(WC_matches_2022$possession.team2)
WC_matches_2022$Possession.Diff  <- WC_matches_2022$possession.team1 - WC_matches_2022$possession.team2

WC_matches_2022$Shots.Diff       <- WC_matches_2022$total.attempts.team1 - WC_matches_2022$total.attempts.team2
WC_matches_2022$Shots.On.Target.Diff <- WC_matches_2022$on.target.attempts.team1 - WC_matches_2022$on.target.attempts.team2

#Les colonnes fouls sont en "against" et non "committed by", on renomme pour inverser
names(WC_matches_2022)[names(WC_matches_2022) == "fouls.against.team1"] <- "fouls.team1"
names(WC_matches_2022)[names(WC_matches_2022) == "fouls.against.team2"] <- "fouls.team2"
WC_matches_2022$Fouls.Diff <- WC_matches_2022$fouls.team1 - WC_matches_2022$fouls.team2


#Suppression des colonnes inutiles
WC_matches_2022_22 <- subset(WC_matches_2022, select = c(1:7, 11, 12, 21, 22, 57:62, 89:96))

#Uniformisation des nom de pays
WC_matches_2022_22 <- WC_matches_2022_22 %>% 
  mutate(team1 = ifelse(team1 == "IRAN", "IR IRAN", team1))
WC_matches_2022_22 <- WC_matches_2022_22 %>%
  mutate(team2 = ifelse(team2 == "IRAN", "IR IRAN", team2))

#On renomme les colonnes pour qu'elles soient identiques à celles de WC_database
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "team1"]                 <- "Home"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "team2"]                 <- "Away"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "number.of.goals.team1"] <- "Home.Goals"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "number.of.goals.team2"] <- "Away.Goals"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "yellow.cards.team1"]    <- "Home.Yellow.Card.Count"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "yellow.cards.team2"]    <- "Away.Yellow.Card.Count"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "red.cards.team1"]       <- "Home.Red.Card.Count"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "red.cards.team2"]       <- "Away.Red.Card.Count"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "total.attempts.team1"]  <- "hshots"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "total.attempts.team2"]  <- "ashots"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "on.target.attempts.team1"] <- "hshotsOnTarget"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "on.target.attempts.team2"] <- "ashotsOnTarget"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "fouls.team1"]           <- "hfouls"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "fouls.team2"]           <- "afouls"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "possession.team1"]      <- "hPossession"
names(WC_matches_2022_22)[names(WC_matches_2022_22) == "possession.team2"]      <- "aPossession"

#On va maintenant cherche à faire une base de données avec les données de la Coupe du Monde 2022 et les données de la base de données WC_database

# remplacer les valeurs manquantes dans WC_database avec les valeurs correspondantes dans WC_matches_2022_22
WC_database$Home <- tolower(trimws(WC_database$Home))
WC_database$Away <- tolower(trimws(WC_database$Away))
WC_database$Year <- as.integer(WC_database$Year)

WC_matches_2022_22$Home <- tolower(trimws(WC_matches_2022_22$Home))
WC_matches_2022_22$Away <- tolower(trimws(WC_matches_2022_22$Away))
WC_matches_2022_22$Year <- as.integer(WC_matches_2022_22$Year)



for (i in 1:nrow(WC_database)) {
  if (is.na(WC_database$hshots[i]) && WC_database$Year[i] == 2022) {
    home_team <- WC_database$Home[i]
    away_team <- WC_database$Away[i]
    year      <- WC_database$Year[i]
    matching_row <- match(paste(home_team, away_team, year),
                          paste(WC_matches_2022_22$Home, WC_matches_2022_22$Away, WC_matches_2022_22$Year))
    WC_database$hshots[i]                 <- WC_matches_2022_22$hshots[matching_row]
    WC_database$ashots[i]                 <- WC_matches_2022_22$ashots[matching_row]
    WC_database$hPossesion[i]             <- WC_matches_2022_22$hPossession[matching_row]
    WC_database$aPossesion[i]             <- WC_matches_2022_22$aPossession[matching_row]
    WC_database$hshotsOnTarget[i]         <- WC_matches_2022_22$hshotsOnTarget[matching_row]
    WC_database$ashotsOnTarget[i]         <- WC_matches_2022_22$ashotsOnTarget[matching_row]
    WC_database$hfouls[i]                 <- WC_matches_2022_22$hfouls[matching_row]
    WC_database$afouls[i]                 <- WC_matches_2022_22$afouls[matching_row]
    WC_database$Home.Yellow.Card.Count[i] <- WC_matches_2022_22$Home.Yellow.Card.Count[matching_row]
    WC_database$Away.Yellow.Card.Count[i] <- WC_matches_2022_22$Away.Yellow.Card.Count[matching_row]
    WC_database$Home.Red.Card.Count[i]    <- WC_matches_2022_22$Home.Red.Card.Count[matching_row]
    WC_database$Away.Red.Card.Count[i]    <- WC_matches_2022_22$Away.Red.Card.Count[matching_row]
    WC_database$Possession.Diff[i]        <- WC_matches_2022_22$Possession.Diff[matching_row]
    WC_database$Shots.Diff[i]             <- WC_matches_2022_22$Shots.Diff[matching_row]
    WC_database$Shots.On.Target.Diff[i]   <- WC_matches_2022_22$Shots.On.Target.Diff[matching_row]
    WC_database$Fouls.Diff[i]             <- WC_matches_2022_22$Fouls.Diff[matching_row]
    WC_database$Yellow.Cards.Diff[i]      <- WC_matches_2022_22$Yellow.Cards.Diff[matching_row]
    WC_database$Red.Cards.Diff[i]         <- WC_matches_2022_22$Red.Cards.Diff[matching_row]
  }
}

#On ajoute une colonne valant 1 si Home gagne et 0 sinon. On peut utiliser la différence de but pour ça (si Home gagne, Diff > 0)
WC_database$Home.Win <- ifelse(WC_database$Goals_Diff > 0, 1, 0)

```


## 2.4 Traitement du classement FIFA

```{r}
FIFA_rank <- read.csv("WC Data/fifa_ranking-2022-12-22 (Rank).csv",
                    header = TRUE,
                    sep = ",",
                    stringsAsFactors = FALSE)

#On garde les dates d'un mois avant chaque Coupe du Monde
FIFA_rank <- subset(FIFA_rank,
                    ifelse(year(FIFA_rank$rank_date) == 2022, 
                    month(FIFA_rank$rank_date) == 10,
                    month(FIFA_rank$rank_date) == 5))
FIFA_rank$rank_date <- as.Date(FIFA_rank$rank_date)
FIFA_rank$Year      <- format(FIFA_rank$rank_date, "%Y")

#On ne garde que les années de la Coupe du Monde
FIFA_rank <- subset(FIFA_rank,year(FIFA_rank$rank_date) %in% c(1994, 1998, 2002, 2006,
                                                               2010, 2014, 2018, 2022))

#Uniformisation des noms de pays
FIFA_rank$country_full <- gsub("USA", "United States", FIFA_rank$country_full)
FIFA_rank$country_full <- gsub("Turkey", "Türkiye", FIFA_rank$country_full)
FIFA_rank$country_full <- gsub("Yugoslavia", "fr Yugoslavia", FIFA_rank$country_full)

FIFA_rank$Year              <- as.integer(FIFA_rank$Year)
FIFA_rank$country_full      <- tolower(FIFA_rank$country_full)
WC_database$FIFA_Rank.Home <- 0
WC_database$FIFA_Rank.Away <- 0

#Fonction qui récupère le classement FIFA d'une équipe pour une année donnée
get_rank <- function(year, team){
  rank <- FIFA_rank$rank[which(FIFA_rank$country_full == team & FIFA_rank$Year == year)]
  if(length(rank) > 0){
    return(rank)
  } else {
    return(NA)
  }
}

#Ajout des classements FIFA dans le dataframe "WC_database"
for (i in 1:nrow(WC_database)) {
  WC_database$FIFA_Rank.Home[i] <- get_rank(WC_database$Year[i], WC_database$Home[i])
  WC_database$FIFA_Rank.Away[i] <- get_rank(WC_database$Year[i], WC_database$Away[i])
}

#Colonne de différence
WC_database$FIFA_Rank.Diff <- WC_database$FIFA_Rank.Home - WC_database$FIFA_Rank.Away
```

## 2.5 Création d'une dataframe par coupe du monde

```{r}
#On crée une dataframe par coupe du monde
WC_1994 <- subset(WC_database, Year == 1994)
WC_1998 <- subset(WC_database, Year == 1998)
WC_2002 <- subset(WC_database, Year == 2002)
WC_2006 <- subset(WC_database, Year == 2006)
WC_2010 <- subset(WC_database, Year == 2010)
WC_2014 <- subset(WC_database, Year == 2014)
WC_2018 <- subset(WC_database, Year == 2018)
WC_2022 <- subset(WC_database, Year == 2022)
```

# 3. Statistiques descriptives

## 3.1 Moyenne de buts par match

```{r}
plotly::plot_ly(x = c(1994, 1998, 2002, 2006, 2010, 2014, 2018, 2022),
                y = c(mean(WC_1994$Home.Goals), mean(WC_1998$Home.Goals),
                      mean(WC_2002$Home.Goals), mean(WC_2006$Home.Goals),
                      mean(WC_2010$Home.Goals), mean(WC_2014$Home.Goals),
                      mean(WC_2018$Home.Goals), mean(WC_2022$Home.Goals)),
                type = "bar",
                name = "Home Goals") %>%
      add_trace(y = c(mean(WC_1994$Away.Goals), mean(WC_1998$Away.Goals),
                  mean(WC_2002$Away.Goals), mean(WC_2006$Away.Goals),
                  mean(WC_2010$Away.Goals), mean(WC_2014$Away.Goals),
                  mean(WC_2018$Away.Goals), mean(WC_2022$Away.Goals)),
                name = "Away Goals") %>%
      layout(title = "Moyenne de buts par match",
                xaxis = list(title = "Year"),
                yaxis = list(title = "Goals"))
```

Nous constatons une stabilité de la moyenne de buts marqués au fil des différentes éditions de la Coupe du Monde. Par ailleurs, nous remarquons que la moyenne de buts marqués à domicile est légèrement supérieure à celle à l'extérieur, bien que le choix de l'équipe à domicile et à l'extérieur soit déterminé par un tirage au sort.

## 3.2 Moyenne de carton jaune et rouge par match

```{r}
plotly::plot_ly(x = c(1994, 1998, 2002, 2006, 2010, 2014, 2018, 2022),
                y = c(mean(WC_1994$Home.Yellow.Card.Count), mean(WC_1998$Home.Yellow.Card.Count),
                      mean(WC_2002$Home.Yellow.Card.Count), mean(WC_2006$Home.Yellow.Card.Count),
                      mean(WC_2010$Home.Yellow.Card.Count), mean(WC_2014$Home.Yellow.Card.Count),
                      mean(WC_2018$Home.Yellow.Card.Count), mean(WC_2022$Home.Yellow.Card.Count)),
                type = "bar",
                name = "Home Yellow Cards") %>%
      add_trace(y = c(mean(WC_1994$Away.Yellow.Card.Count), mean(WC_1998$Away.Yellow.Card.Count), mean(WC_2002$Away.Yellow.Card.Count), mean(WC_2006$Away.Yellow.Card.Count), mean(WC_2010$Away.Yellow.Card.Count), mean(WC_2014$Away.Yellow.Card.Count), mean(WC_2018$Away.Yellow.Card.Count), mean(WC_2022$Away.Yellow.Card.Count)),
                name = "Away Yellow Cards") %>%
      layout(title = "Moyenne de carton jaune par match",
                xaxis = list(title = "Year"),
                yaxis = list(title = "Yellow Cards"))
```

```{r}
plotly::plot_ly(x = c(1994, 1998, 2002, 2006, 2010, 2014, 2018, 2022),
                y = c(mean(WC_1994$Home.Red.Card.Count), mean(WC_1998$Home.Red.Card.Count),
                      mean(WC_2002$Home.Red.Card.Count), mean(WC_2006$Home.Red.Card.Count),
                      mean(WC_2010$Home.Red.Card.Count), mean(WC_2014$Home.Red.Card.Count),
                      mean(WC_2018$Home.Red.Card.Count), mean(WC_2022$Home.Red.Card.Count)),
                type = "bar",
                name = "Home Red Cards") %>%
      add_trace(y = c(mean(WC_1994$Away.Red.Card.Count), mean(WC_1998$Away.Red.Card.Count), mean(WC_2002$Away.Red.Card.Count), mean(WC_2006$Away.Red.Card.Count), mean(WC_2010$Away.Red.Card.Count), mean(WC_2014$Away.Red.Card.Count), mean(WC_2018$Away.Red.Card.Count), mean(WC_2022$Away.Red.Card.Count)),
                name = "Away Red Cards") %>%
      layout(title = "Moyenne de carton rouge par match",
                xaxis = list(title = "Year"),
                yaxis = list(title = "Red Cards"))
```

Nous pouvons observer une diminution du nombre de cartons jaunes et rouges par match au fil des années de la Coupe du Monde. Cette tendance peut être expliquée par une possible évolution dans la sévérité des arbitres, qui pourraient être de moins en moins stricts dans leur distribution de cartons, ou par une amélioration du comportement disciplinaire des joueurs, notamment depuis l'introduction de la VAR qui permet de mieux contrôler les fautes commises.

# 4.Modèle de régression linéaire

Le modèle de regression linéaire suivant est estimé pour chaque année de la Coupe du Monde :

\[\Delta \text{Buts}_t^i = \beta_0 + \beta_1 \Delta \text{Rank}_t^i + \beta_2 \Delta \text{X}_t^i + \beta_3 \Delta \text{Attendence}_t^i + \varepsilon_t^i\]

avec le match i, de l'année de coupe du monde t, et $\Delta \text{X}_t^i$ le vecteur des variables de contrôles. Le vecteur X contient, selon les années, plus ou moins de variables de contrôle en fonction des données qui disponibles. Cependant à partir de 2006, les variables de contrôle sont : La différence du nombre de carton jaune, rouge, du nombre de fautes, de possession, du nombre de tirs et de tirs cadrés. Pour certaines années, la différence du nombre d'arrêt est incluse.

## 4.1 Estimations des modèles des modèles

On divise les différentes Coupes du Monde en deux sous ensemble : 1994, 1998 et 2002, et 2006, 2010, 2014, 2018 et 2022. La répartition permet de regroupés les modèles pour lesquels nous avons peu de variables de contrôle de ceux pour lesquels nous en avons plusieurs.

```{r}
#Groupe 1
model_1994 <- lm(Goals_Diff ~ FIFA_Rank.Diff + Yellow.Card.Diff +
                              Red.Card.Diff  + Attendance,
                              data = WC_1994)
model_1998 <- lm(Goals_Diff ~ FIFA_Rank.Diff + Yellow.Card.Diff +
                              Red.Card.Diff  + Attendance,
                              data = WC_1998)
model_2002 <- lm(Goals_Diff ~ FIFA_Rank.Diff + Yellow.Card.Diff +
                              Red.Card.Diff  + Attendance,
                              data = WC_2002)

#Groupe 2
model_2006 <- lm(Goals_Diff ~ FIFA_Rank.Diff + Yellow.Card.Diff + Red.Card.Diff +
                              Fouls.Diff     + Possession.Diff  + Shots.Diff    +
                              Shots.On.Target.Diff + Saves.Diff + Attendance,
                              data = WC_2006)
model_2010 <- lm(Goals_Diff ~ FIFA_Rank.Diff + Yellow.Card.Diff + Red.Card.Diff +
                              Fouls.Diff     + Possession.Diff  + Shots.Diff    +
                              Shots.On.Target.Diff + Saves.Diff + Attendance,
                              data = WC_2010)
model_2014 <- lm(Goals_Diff ~ FIFA_Rank.Diff + Yellow.Card.Diff + Red.Card.Diff +
                              Fouls.Diff     + Possession.Diff  + Shots.Diff    +
                              Shots.On.Target.Diff + Saves.Diff + Attendance,
                              data = WC_2014)
model_2018 <- lm(Goals_Diff ~ FIFA_Rank.Diff + Yellow.Card.Diff + Red.Card.Diff +
                              Fouls.Diff     + Possession.Diff  + Shots.Diff    +
                              Shots.On.Target.Diff + Saves.Diff + Attendance,
                              data = WC_2018)
model_2022 <- lm(Goals_Diff ~ FIFA_Rank.Diff + Yellow.Card.Diff + Red.Card.Diff +
                              Fouls.Diff     + Possession.Diff  + Shots.Diff    +
                              Shots.On.Target.Diff + Attendance,
                              data = WC_2022)

```

## 4.2 Tests d'hétéroscédasticité, d'autocorrelation et de multicolinéarité
  
```{r}
#Test de Breusch-Pagan (hétéroscédasticité)
bp_1994 <- bptest(model_1994)
bp_1998 <- bptest(model_1998)
bp_2002 <- bptest(model_2002)
bp_2006 <- bptest(model_2006)
bp_2010 <- bptest(model_2010)
bp_2014 <- bptest(model_2014)
bp_2018 <- bptest(model_2018)
bp_2022 <- bptest(model_2022)

#Test de Durbin-Watson (autocorrelation)
dw_1994 <- dwtest(model_1994)$p.value[1]
dw_1998 <- dwtest(model_1998)$p.value[1]
dw_2002 <- dwtest(model_2002)$p.value[1]
dw_2006 <- dwtest(model_2006)$p.value[1]
dw_2010 <- dwtest(model_2010)$p.value[1]
dw_2014 <- dwtest(model_2014)$p.value[1]
dw_2018 <- dwtest(model_2018)$p.value[1]
dw_2022 <- dwtest(model_2022)$p.value[1]

#Test VIF (multicolinéarité)
vif_1994 <- vif(model_1994)[1]
vif_1998 <- vif(model_1998)[1]
vif_2002 <- vif(model_2002)[1]
vif_2006 <- vif(model_2006)[1]
vif_2010 <- vif(model_2010)[1]
vif_2014 <- vif(model_2014)[1]
vif_2018 <- vif(model_2018)[1]
vif_2022 <- vif(model_2022)[1]

#Tableau récapitulatif des tests
tests <- data.frame(Model      = c("1994", "1998", "2002", "2006", "2010", "2014", "2018", "2022"),
                    BP_p_value = round(c(bp_1994$p.value, bp_1998$p.value, bp_2002$p.value,
                                         bp_2006$p.value, bp_2010$p.value, bp_2014$p.value,
                                         bp_2018$p.value, bp_2022$p.value), 4),
                    DW_p_value = round(c(dw_1994, dw_1998, dw_2002,
                                         dw_2006, dw_2010, dw_2014,
                                         dw_2018, dw_2022), 4),
                    VIF_Value  = round(c(vif_1994, vif_1998, vif_2002,
                                         vif_2006, vif_2010, vif_2014,
                                         vif_2018, vif_2022), 4))
tests
```

## 4.2 Résultats

Pour ces 4 Coupes du Monde, les statistiques disponibles sont plus nombreuses.
```{r}
stargazer(model_1994, model_1998, model_2002,
          type = "text",
          digits = 3,
          title = "Modèle de régression linéaire pour la Coupe du Monde 1994, 1998 et 2002", 
          column.labels = c("1994", "1998", "2002"))

stargazer(model_2006, model_2010, model_2014, model_2018, model_2022,
          type = "text",
          digits = 3,
          df = FALSE,
          title = "Modèle de régression linéaire pour la Coupe du Monde 2006, 2010 et 2014", 
          column.labels = c("2006", "2010", "2014", "2018", "2022"))
```

Dans le groupe des Coupes du Monde de 1994, 1998 et 2002, le seul coefficient significatif est celui lié à la variable de différence de classement FIFA. Le coefficient négatif significatif indique que les équipes ayant un classement FIFA plus élevé ont tendance à marquer plus de buts que les autres équipes. De plus, la variable de différence de carton rouge est significative et négative pour l'année 2002. Cela implique qu'un carton rouge est associé à une diminution du nombre de buts marqués, toutes choses étant égales par ailleurs. Cela peut suggérer que les équipes qui reçoivent plus de cartons rouges ont du mal à maintenir leur stratégie de jeu, ce qui peut affaiblir leur performance sur le terrain et leur capacité à marquer.
  
Contrairement à la conclusion de Saumik Paul et Ronita Mitra, le coefficient associé à la variable d'affluence ne peut pas être interprété, car il n'est pas significatif au seuil de 5% et est très proche de 0. De même, le coefficient associé à la variable de différence de carton jaune n'est pas significatif et ne peut donc pas être interprété.
  
De manière plus générale, on constate que le coefficient de détermination $R²$ est en moyenne de 0.2 sur nos 3 modèles. Cela signifie que seulement 20% de la variation de la différence de buts est expliquée en moyenne par le modèle, permettant de conclure qu'il n'est pas correctement estimé.
  
  
Dans le deuxième groupe, qui concerne les Coupes du Monde de 2006, 2010, 2014, 2018 et 2022, il y a beaucoup plus de variables significatives même si le classement FIFA n'est désormais plus significatif pour toutes les éditions de la Coupe du Monde. Cela peut être dû à l'ajout de variables de contrôle qui capturent des aspects importants des performances des équipes liés au classement FIFA mais qui ne sont pas mesurés directement par celui-ci.

On observe que les variables de possession de balle ainsi que celles des cartons jaunes ne sont pas significatives. Cela indique que le fait de garder davantage la balle ou d'être plus agressif n'a pas d'impact sur la différence de but finale.
  
En revanche, les variables de tirs cadrés et d'arrêts sont significatives et positives au seuil de 5% pour chaque édition de la Coupe du Monde. Les équipes qui ont plus de tirs cadrés ont tendance à marquer plus de buts. Cela vient contraster avec la non-significativité du coefficient associé à la variable tir. En effet, le simple fait de tirer plus au but n'augmente pas nécessairement la probabilité de marquer selon notre modèle. La variable de différence d'arrêt donne la réflexion inverse de la variable tir : plus une équipe a un bon gardien et une défense solide, moins elle a de chance de concéder un but.
  
Le modèle appliqué au deuxième groupe de Coupe du Monde se démarque par sa fiabilité, en contraste avec celui appliqué au premier groupe. En effet, le coefficient de détermination $R²$ présente une moyenne de 0,63, ce qui révèle que le modèle peut expliquer en moyenne 62% de la variation de la différence de buts. Il est à noter que pour l'édition 2018, le modèle peut expliquer jusqu'à 90% de cette variation, témoignant ainsi de la pertinence de ses prévisions.

# 5. Modèle probit

A la différence du modèle MCO, le modèle probit cherche à prédire une variable binaire. Les variables explicatives sont des variables continues mais la variable expliquée prend oui/non comme valeur.

\begin{equation}
Win_{t}^{i} = \alpha_{t} + \beta_{1,t} \cdot Rank_{t}^{i} + \beta_{2,t} \cdot X_{t}^{i} + \epsilon_{t}^{i}
\end{equation}

où :

- $Win_{t}^{i}$ est une variable dummy qui mesure si le match i de la coupe du monde t a été gagné par l'équipe qui joue à domicile ou non.

- $Rank_{t}^{i}$ est le rang de l'équipe qui joue à domicile.

- $X_{t}^{i}$ est un vecteur comprenant les variables de contrôle telles que le nombre de carton jaune, le nombre de carton rouge, le nombre de tirs cadrés, etc.


Le modèle peut se réécrire comme suit :

$$ P(Win_{t}^{i}=1 | Rank_{t}^{i},X_{t}^{i}) = \Phi(\alpha + \beta_1 Rank_{t}^{i} + \beta_2 X_{t}^{i} + \epsilon_{t}^{i}) $$

où $\Phi$ représente la fonction de répartition cumulative de la distribution normale standard.

On dit que la probabilité que l'équipe $i$ gagne le match de la Coupe du Monde $t$ étant donné son classement $Rank_{t}^{i}$ et les variables de contrôles $X_{t}^{i}$ est donnée par la fonction de répartition cumulative de la variable aléatoire normale standardisée $\alpha + \beta_1 Rank_{t}^{i} + \beta_2 X_{t}^{i} + \epsilon_{t}^{i}$. En d'autres termes, $\Phi$ calcule la probabilité que la variable aléatoire suit une distribution normale standard et prend une valeur inférieure ou égale à une certaine valeur donnée.

## 5.1 Nouveau dataframe

Contrairement au modèle de régression linéaire précédent où chaque match était considéré comme une seule observation, le modèle probit prend en compte deux observations pour chaque match. Par match, il y a deux équipes, chacune ayant une probabilité de gagner différente, ce qui nécessite d'examiner chaque match du point de vue de l'équipe à domicile et de celui de l'équipe à l'extérieur.

Nous avons donc fait un nouveau dataframe qui empile les données, ne regardant plus chaque équipe comme à domicile ou à l'extérieur, mais comme "gagne ou ne gagne pas". Cette nouvelle variable représentera notre dummy.

```{r}
WC_Probit <- data.frame()

for (i in 1:nrow(WC_database)) {
  #Equipe à domicile
  home_team            <- WC_database[i, "Home"]
  home_goals           <- WC_database[i, "Home.Goals"]
  home_red_cards       <- WC_database[i, "Home.Red.Card.Count"]
  home_yellow_cards    <- WC_database[i, "Home.Yellow.Card.Count"]
  home_substitutions   <- WC_database[i, "Home.Substitution.Count"]
  home_possession      <- WC_database[i, "hPossesion"]
  home_shots_on_target <- WC_database[i, "hshotsOnTarget"]
  home_shots           <- WC_database[i, "hshots"]
  home_fouls           <- WC_database[i, "hfouls"]
  home_saves           <- WC_database[i, "hsaves"]

  #Equipe à l'extérieur
  away_team             <- WC_database[i, "Away"]
  away_goals            <- WC_database[i, "Away.Goals"]
  away_red_cards        <- WC_database[i, "Away.Red.Card.Count"]
  away_yellow_cards     <- WC_database[i, "Away.Yellow.Card.Count"]
  away_substitutions    <- WC_database[i, "Away.Substitution.Count"]
  away_possession       <- WC_database[i, "aPossesion"]
  away_shots_on_target  <- WC_database[i, "ashotsOnTarget"]
  away_shots            <- WC_database[i, "ashots"]
  away_fouls            <- WC_database[i, "afouls"]
  away_saves            <- WC_database[i, "asaves"]
  
  home_observation <- data.frame(Team = home_team,
                                 Goals = home_goals,
                                 Red_Cards = home_red_cards,
                                 Yellow_Cards = home_yellow_cards,
                                 Substitutions = home_substitutions,
                                 Possession = home_possession,
                                 Shots_On_Target = home_shots_on_target,
                                 Shots = home_shots,
                                 Fouls = home_fouls,
                                 Saves = home_saves,
                                 Win = ifelse(home_goals > away_goals, 1, 0),
                                 Year = WC_database[i, "Year"],
                                 Round = WC_database[i, "Round"])
  
  away_observation <- data.frame(Team = away_team,
                                 Goals = away_goals,
                                 Red_Cards = away_red_cards,
                                 Yellow_Cards = away_yellow_cards,
                                 Substitutions = away_substitutions,
                                 Possession = away_possession,
                                 Shots_On_Target = away_shots_on_target,
                                 Shots = away_shots,
                                 Fouls = away_fouls,
                                 Saves = away_saves,
                                 Win = ifelse(away_goals > home_goals, 1, 0),
                                 Year = WC_database[i, "Year"],
                                 Round = WC_database[i, "Round"])
  
  WC_Probit <- rbind(WC_Probit, home_observation, away_observation)
}

WC_Probit <- merge(WC_Probit, FIFA_rank,
                   by.x = c("Team", "Year"),
                   by.y = c("country_full", "Year"),
                   all.x = TRUE)
WC_Probit <- WC_Probit[,-c(15:20)]

```

## 5.2 Estimation des modèles

### 5.2.1 Modèle probit pour 1994, 1998 et 2002

Les données disponibles pour ces 3 éditions de Coupe du monde sont limitées, nous estimons donc les 3 modèle à part.

```{r}
#CDM 1994
model_probit_1994 <- glm(Win ~ rank + Goals + Yellow_Cards + Red_Cards,
                               data = WC_Probit[WC_Probit$Year == 1994,],
                               family = binomial(link = "logit"))

#CDM 1998
model_probit_1998 <- glm(Win ~ rank + Goals + Yellow_Cards + Red_Cards,
                               data = WC_Probit[WC_Probit$Year == 1998,],
                               family = binomial(link = "logit"))

#CDM 2002
model_probit_2002 <- glm(Win ~ rank + Goals + Yellow_Cards + Red_Cards,
                               data = WC_Probit[WC_Probit$Year == 2002,],
                               family = binomial(link = "logit"))
```

### 5.2.2 Modèle probit pour 2006, 2010, 2014, 2018 et 2022

```{r}
model_probit_2006 <- glm(Win ~ rank + Goals + Yellow_Cards  +
                               Red_Cards    + Substitutions +
                               Possession   + Shots         +
                               Shots_On_Target + Fouls      +
                               Saves,
                               na.action = na.exclude,
                               data = WC_Probit[WC_Probit$Year == 2006,],
                               family = binomial(link = "logit"))


#CDM 2010
model_probit_2010 <- glm(Win ~ rank + Goals + Yellow_Cards  +
                               Red_Cards    + Substitutions +
                               Possession   + Shots         +
                               Shots_On_Target + Fouls      +
                               Saves,
                               na.action = na.exclude,
                               data = WC_Probit[WC_Probit$Year == 2010,],
                               family = binomial(link = "logit"))

#CDM 2014
model_probit_2014 <- glm(Win ~ rank + Goals + Yellow_Cards  +
                               Red_Cards    + Substitutions +
                               Possession   + Shots         +
                               Shots_On_Target + Fouls      +
                               Saves,
                               na.action = na.exclude,
                               data = WC_Probit[WC_Probit$Year == 2014,],
                               family = binomial(link = "logit"))

#CDM 2018
model_probit_2018 <- glm(Win ~ rank + Goals + Yellow_Cards  +
                               Red_Cards    + Substitutions +
                               Possession   + Shots         +
                               Shots_On_Target + Fouls      +
                               Saves,
                               na.action = na.exclude,
                               data = WC_Probit[WC_Probit$Year == 2018,],
                               family = binomial(link = "logit"))

#CDM 2022
model_probit_2022 <- glm(Win ~ rank + Goals + Yellow_Cards  +
                               Red_Cards    + Substitutions +
                               Possession   + Shots         +
                               Shots_On_Target + Fouls,
                               na.action = na.exclude,
                               data = WC_Probit[WC_Probit$Year == 2022,],
                               family = binomial(link = "logit"))
```

## 5.3 Résultats

```{r}
stargazer(model_probit_1994, model_probit_1998, model_probit_2002,
          type = "text",
          title = "Probit model for the World Cup 1994, 1998 and 2002",
          column.labels = c("1994", "1998", "2002"),
          dep.var.labels = "Win")

stargazer(model_probit_2006, model_probit_2010, model_probit_2014,
          type = "text",
          title = "Probit model for the World Cup 2006, 2010, 2014",
          column.labels = c("2006", "2010", "2014", "2018", "2022"),
          dep.var.labels = "Win")

stargazer(model_probit_2018, model_probit_2022,
          type = "text",
          title = "Probit model for the World Cup 2018 and 2022",
          column.labels = c("2018", "2022"),
          dep.var.labels = "Win")
```
Le coefficient relatif à la variable du nombre de buts marqués est systématiquement positif et significatif dans tous les modèles. En effet, cela semble logique car marquer des buts accroît les chances de gagner.
Quant au coefficient associé aux variables cartons jaunes et rouges, il ne présente pas toujours une significativité statistique et son signe varie selon les éditions de la Coupe du Monde. Lorsqu'il est positif, cela indique que le fait de recevoir un carton jaune ou rouge peut accroître la probabilité de remporter le match, tandis qu'un coefficient négatif indique une diminution de cette probabilité. L'alternance de signe de ce coefficient révèle que le style de jeu défensif efficace (agressif ou plutôt passif) varie selon les éditions de la compétition.

L'absence de signification du classement FIFA indique que cette mesure n'est guère un indicateur fiable des résultats d'un match de la Coupe du Monde. En effet, le classement FIFA est établi en utilisant une méthode discrète qui tient compte des performances passées de l'équipe. Toutefois, cette approche peut ne pas rendre compte avec exactitude de la qualité actuelle de l'équipe ou de son aptitude à gagner des matches dans le cadre particulier de la Coupe du Monde, qui diffère de toute autre phase éliminatoire ou compétition.

Quant aux coefficients relatifs aux tirs et tirs cadrés, ils ne sont significatifs qu'au cours de l'édition de 2014. Cette situation peut paraître surprenante, car l'on pourrait supposer que les équipes qui tirent le plus souvent et le plus précisément ont une plus grande probabilité de marquer des buts et, partant, de remporter la victoire. Cependant, il existe plusieurs raisons pour lesquelles ces variables peuvent ne pas être significatives dans les modèles. Tout d'abord, la précision et le nombre de tirs ne sont que des indicateurs de la performance offensive, tandis que d'autres facteurs tels que la performance défensive peuvent s'avérer plus importants pour la victoire. En outre, la qualité des tirs, comme leur lieu, leur moment et leur contexte, peut influer sur le résultat et n'est pas prise en compte dans ce modèle.

# 6. Conclusion

